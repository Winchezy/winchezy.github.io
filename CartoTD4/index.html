<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Géolocalisation IA - Contrôle par Gestes</title>

    <!-- Leaflet CSS pour la carte 2D -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        .container {
            position: relative;
            width: 100%;
            height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
        }

        #map-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 400px;
            height: 300px;
            z-index: 100;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        #video-container {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

        .video-wrapper {
            flex: 2;
            position: relative;
            min-height: 0;
        }

        #video {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            object-fit: contain;
        }

        #instructions {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            overflow-y: auto;
            min-width: 200px;
        }

        #instructions h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        #instructions ul {
            margin-left: 20px;
        }

        #instructions li {
            margin: 5px 0;
        }

        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            z-index: 1000;
            font-weight: bold;
            text-align: center;
        }

        .info-panel {
            position: absolute;
            top: 340px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 250px;
            max-width: 300px;
        }

        .info-item {
            margin: 8px 0;
            font-size: 14px;
        }

        .info-label {
            font-weight: bold;
            color: #667eea;
            display: inline-block;
            width: 120px;
        }

        .gesture-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .gesture-indicator.active {
            display: block;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }


        @media (max-width: 768px) {
            #map-panel {
                width: 250px;
                height: 200px;
                top: 10px;
                right: 10px;
            }

            #video-container {
                flex-direction: column;
            }

            .video-wrapper {
                flex: 2;
                min-height: 300px;
            }

            #instructions {
                flex: 1;
                max-height: 200px;
            }

            .info-panel {
                top: 220px;
                right: 10px;
                font-size: 12px;
                min-width: 200px;
                padding: 10px;
            }
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #667eea;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Vidéo et reconnaissance de gestes (principal) -->
        <div class="panel" id="video-container">
            <div class="video-wrapper">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" class="canvas-overlay"></canvas>
            </div>
            <div id="instructions">
                <h3>Contrôles par Gestes :</h3>
                <ul>
                    <li><strong>Main ouverte</strong> : Dézoomer la carte</li>
                    <li><strong>Main fermée (poing)</strong> : Zoomer la carte</li>
                    <li><strong>Pincement (pouce + majeur)</strong> : Maintenir pour déplacer la carte</li>
                </ul>
            </div>
        </div>

        <!-- Carte 2D (en haut à droite) -->
        <div class="panel" id="map-panel">
            <div class="header">Carte 2D - Votre Position</div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Panneau d'informations -->
    <div class="info-panel">
        <div class="info-item">
            <span class="info-label">Latitude :</span>
            <span id="lat">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Longitude :</span>
            <span id="lon">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Précision :</span>
            <span id="accuracy">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Geste détecté :</span>
            <span id="gesture">Aucun</span>
        </div>
        <div class="info-item">
            <span class="info-label">Debug doigts-paume :</span>
            <span id="debug-palm">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Debug ouverture :</span>
            <span id="debug-open">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Debug pincement :</span>
            <span id="debug-pinch">--</span>
        </div>
    </div>

    <!-- Indicateur de geste -->
    <div class="gesture-indicator" id="gesture-indicator">
        Geste détecté !
    </div>

    <!-- Contrôles -->
    <div class="controls">
        <button id="toggle-camera">Démarrer Caméra</button>
        <button id="freeze-debug">Geler Debug</button>
    </div>

    <!-- Bibliothèques -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

    <script>
        // ========== VARIABLES GLOBALES ==========
        let map, marker, circle;
        let video, handpose, predictions = [];
        let canvas, ctx;
        let currentPosition = null;
        let currentGesture = null;
        let lastActionTime = 0;
        let gestureRepeatInterval = null;
        let isPinching = false;
        let lastPinchPosition = null;
        let lastHandOpenness = null;
        let debugFrozen = false;
        let frozenDebugValues = { palm: 0, open: 0, pinch: 0 };

        // ========== INITIALISATION ==========
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            initMap();
            setupGeolocation();
            setupCameraControls();
            setupDebugControls();
            // Démarrer la caméra automatiquement
            startCamera();
            document.getElementById('toggle-camera').textContent = 'Arrêter Caméra';
        }

        function setupDebugControls() {
            const freezeButton = document.getElementById('freeze-debug');
            freezeButton.addEventListener('click', () => {
                debugFrozen = !debugFrozen;
                freezeButton.textContent = debugFrozen ? 'Dégeler Debug' : 'Geler Debug';
                freezeButton.style.background = debugFrozen ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            });
        }

        // ========== CARTE 2D (LEAFLET) ==========
        function initMap() {
            map = L.map('map').setView([43.7102, 7.2620], 13); // Nice par défaut

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            marker = L.marker([43.7102, 7.2620]).addTo(map);
            circle = L.circle([43.7102, 7.2620], {
                color: '#667eea',
                fillColor: '#764ba2',
                fillOpacity: 0.3,
                radius: 100
            }).addTo(map);
        }

        // ========== GÉOLOCALISATION ==========
        function setupGeolocation() {
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const accuracy = position.coords.accuracy;

                        currentPosition = { lat, lon };

                        // Mise à jour carte 2D
                        map.setView([lat, lon], map.getZoom());
                        marker.setLatLng([lat, lon]);
                        circle.setLatLng([lat, lon]);
                        circle.setRadius(accuracy);

                        // Mise à jour interface
                        document.getElementById('lat').textContent = lat.toFixed(6);
                        document.getElementById('lon').textContent = lon.toFixed(6);
                        document.getElementById('accuracy').textContent = `${accuracy.toFixed(0)}m`;
                    },
                    (error) => {
                        console.error('Erreur de géolocalisation:', error);
                        alert('Impossible d\'obtenir votre position. Vérifiez les permissions.');
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 5000
                    }
                );
            } else {
                alert('La géolocalisation n\'est pas supportée par votre navigateur.');
            }
        }

        // ========== CAMÉRA ET IA (ML5.JS) ==========
        function setupCameraControls() {
            const toggleButton = document.getElementById('toggle-camera');
            let cameraActive = false;

            toggleButton.addEventListener('click', () => {
                if (!cameraActive) {
                    startCamera();
                    toggleButton.textContent = 'Arrêter Caméra';
                    cameraActive = true;
                } else {
                    stopCamera();
                    toggleButton.textContent = 'Démarrer Caméra';
                    cameraActive = false;
                }
            });
        }

        function startCamera() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480 },
                audio: false
            })
            .then(stream => {
                video.srcObject = stream;
                video.play();

                video.addEventListener('loadeddata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    initHandpose();
                });
            })
            .catch(err => {
                console.error('Erreur caméra:', err);
                alert('Impossible d\'accéder à la caméra. Vérifiez les permissions.');
            });
        }

        function stopCamera() {
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function initHandpose() {
            handpose = ml5.handpose(video, modelLoaded);
            handpose.on('predict', (results) => {
                predictions = results;
                drawHands();
                detectHandGestures();
            });
        }

        function modelLoaded() {
            console.log('Handpose chargé !');
        }

        function drawHands() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            predictions.forEach(hand => {
                const landmarks = hand.landmarks;

                // Dessiner les points de la main
                landmarks.forEach((landmark, index) => {
                    ctx.beginPath();
                    ctx.arc(landmark[0], landmark[1], 5, 0, 2 * Math.PI);
                    ctx.fillStyle = '#667eea';
                    ctx.fill();
                });

                // Dessiner les connexions
                const connections = [
                    [0, 1], [1, 2], [2, 3], [3, 4], // Pouce
                    [0, 5], [5, 6], [6, 7], [7, 8], // Index
                    [0, 9], [9, 10], [10, 11], [11, 12], // Majeur
                    [0, 13], [13, 14], [14, 15], [15, 16], // Annulaire
                    [0, 17], [17, 18], [18, 19], [19, 20], // Auriculaire
                    [5, 9], [9, 13], [13, 17] // Paume
                ];

                ctx.strokeStyle = '#764ba2';
                ctx.lineWidth = 2;
                connections.forEach(([start, end]) => {
                    ctx.beginPath();
                    ctx.moveTo(landmarks[start][0], landmarks[start][1]);
                    ctx.lineTo(landmarks[end][0], landmarks[end][1]);
                    ctx.stroke();
                });
            });
        }

        // ========== DÉTECTION DE GESTES ==========
        function detectHandGestures() {
            if (predictions.length === 0) {
                isPinching = false;
                lastPinchPosition = null;
                stopGestureRepeat();
                return;
            }

            const hand = predictions[0];
            const landmarks = hand.landmarks;

            // Points clés : 0=poignet, 4=pouce, 8=index, 12=majeur, 16=annulaire, 20=auriculaire
            const thumb = landmarks[4];
            const indexFinger = landmarks[8];
            const middleFinger = landmarks[12];
            const ringFinger = landmarks[16];
            const pinky = landmarks[20];
            const wrist = landmarks[0];

            // Calculer la distance pouce-majeur (pincement)
            const pinchDistance = Math.hypot(thumb[0] - middleFinger[0], thumb[1] - middleFinger[1]);

            // Calculer l'ouverture de la main (distance moyenne des doigts depuis le poignet)
            const avgFingerDistance = (
                Math.hypot(indexFinger[0] - wrist[0], indexFinger[1] - wrist[1]) +
                Math.hypot(middleFinger[0] - wrist[0], middleFinger[1] - wrist[1]) +
                Math.hypot(ringFinger[0] - wrist[0], ringFinger[1] - wrist[1]) +
                Math.hypot(pinky[0] - wrist[0], pinky[1] - wrist[1])
            ) / 4;

            // Calculer la distance entre le bout des doigts et la paume (pour détecter poing)
            const palmCenter = landmarks[9]; // Centre de la paume
            const fingertipsToPalm = (
                Math.hypot(indexFinger[0] - palmCenter[0], indexFinger[1] - palmCenter[1]) +
                Math.hypot(middleFinger[0] - palmCenter[0], middleFinger[1] - palmCenter[1]) +
                Math.hypot(ringFinger[0] - palmCenter[0], ringFinger[1] - palmCenter[1]) +
                Math.hypot(pinky[0] - palmCenter[0], pinky[1] - palmCenter[1])
            ) / 4;

            let detectedGesture = 'none';

            // Afficher les valeurs de debug
            if (!debugFrozen) {
                frozenDebugValues.palm = fingertipsToPalm;
                frozenDebugValues.open = avgFingerDistance;
                frozenDebugValues.pinch = pinchDistance;
            }
            document.getElementById('debug-palm').textContent = frozenDebugValues.palm.toFixed(1);
            document.getElementById('debug-open').textContent = frozenDebugValues.open.toFixed(1);
            document.getElementById('debug-pinch').textContent = frozenDebugValues.pinch.toFixed(1);

            // Détection du pincement (pouce + majeur) - priorité haute
            if (pinchDistance < 50) {
                detectedGesture = 'pinch';
                if (!isPinching) {
                    isPinching = true;
                    lastPinchPosition = { x: thumb[0], y: thumb[1] };
                } else if (lastPinchPosition) {
                    // Déplacement de la carte pendant le pincement
                    const deltaX = thumb[0] - lastPinchPosition.x;
                    const deltaY = thumb[1] - lastPinchPosition.y;

                    // Déplacer la carte proportionnellement au mouvement de la main
                    const currentCenter = map.getCenter();
                    const pixelToLatLng = 0.0001; // Facteur de conversion

                    map.panTo([
                        currentCenter.lat - deltaY * pixelToLatLng,
                        currentCenter.lng + deltaX * pixelToLatLng
                    ], { animate: false });

                    lastPinchPosition = { x: thumb[0], y: thumb[1] };
                }
            } else {
                isPinching = false;
                lastPinchPosition = null;

                // Détection état de la main (ouverte vs fermée) avec hystérésis
                // Poing: doigts-paume ~31.9, ouverture ~63.7
                // Main ouverte: doigts-paume ~85.5, ouverture ~156.0
                if (fingertipsToPalm < 70) {
                    // Main fermée (poing)
                    detectedGesture = 'hand_close';
                } else if (avgFingerDistance > 145) {
                    // Main ouverte - seuil à 145 pour capturer 156
                    detectedGesture = 'hand_open';
                } else {
                    // Zone neutre - garder le geste précédent
                    detectedGesture = currentGesture || 'none';
                }

                lastHandOpenness = avgFingerDistance;
            }

            // Gestion du changement de geste et répétition
            handleGestureChange(detectedGesture);
        }

        function handleGestureChange(newGesture) {
            // Si le geste a changé
            if (newGesture !== currentGesture) {
                console.log('Changement de geste:', currentGesture, '->', newGesture);

                // Arrêter la répétition du geste précédent
                stopGestureRepeat();

                currentGesture = newGesture;

                // Si c'est un geste actif (pas "none"), démarrer la répétition
                if (newGesture === 'hand_close' || newGesture === 'hand_open') {
                    console.log('Démarrage répétition pour:', newGesture);

                    // Exécuter immédiatement
                    executeGestureAction(newGesture);

                    // Puis répéter toutes les secondes
                    gestureRepeatInterval = setInterval(() => {
                        console.log('Répétition action:', newGesture);
                        executeGestureAction(newGesture);
                    }, 1000);
                }

                // Mise à jour de l'interface
                updateGestureDisplay(newGesture);
            }
        }

        function stopGestureRepeat() {
            if (gestureRepeatInterval) {
                clearInterval(gestureRepeatInterval);
                gestureRepeatInterval = null;
            }
            currentGesture = 'none';
        }

        function executeGestureAction(gesture) {
            const now = Date.now();
            console.log('Exécution action:', gesture, 'Zoom actuel:', map.getZoom());

            switch(gesture) {
                case 'hand_close':
                    // Zoom avant avec animation pour forcer le rafraîchissement
                    const currentZoomIn = map.getZoom();
                    const newZoomIn = Math.min(currentZoomIn + 0.5, 19);
                    console.log('Zoom avant:', currentZoomIn, '->', newZoomIn);
                    map.setZoom(newZoomIn, { animate: true });
                    // Forcer l'invalidation de la carte
                    setTimeout(() => map.invalidateSize(), 50);
                    showGestureIndicator('ZOOM AVANT');
                    break;
                case 'hand_open':
                    // Zoom arrière avec animation
                    const currentZoomOut = map.getZoom();
                    const newZoomOut = Math.max(currentZoomOut - 0.5, 1);
                    console.log('Zoom arrière:', currentZoomOut, '->', newZoomOut);
                    map.setZoom(newZoomOut, { animate: true });
                    // Forcer l'invalidation de la carte
                    setTimeout(() => map.invalidateSize(), 50);
                    showGestureIndicator('ZOOM ARRIÈRE');
                    break;
            }

            lastActionTime = now;
        }

        function updateGestureDisplay(gesture) {
            const gestureNames = {
                'pinch': 'PINCEMENT - DÉPLACEMENT',
                'hand_open': 'MAIN OUVERTE - DÉZOOM',
                'hand_close': 'MAIN FERMÉE - ZOOM',
                'none': 'Aucun'
            };
            document.getElementById('gesture').textContent = gestureNames[gesture] || gesture;
        }

        function showGestureIndicator(text) {
            const indicator = document.getElementById('gesture-indicator');
            indicator.textContent = text;
            indicator.classList.add('active');

            setTimeout(() => {
                indicator.classList.remove('active');
            }, 500);
        }

    </script>
</body>
</html>
